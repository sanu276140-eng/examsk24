<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - examsk24.online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="admin-style.css">
    
   <!--Firebase SDK v9-->
     <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyBftJD6pWrx5hAwEr3ep_S8NeqeiHQrCF4",
  authDomain: "examsk24.firebaseapp.com",
  projectId: "examsk24",
  storageBucket: "examsk24.firebasestorage.app",
  messagingSenderId: "569555436896",
  appId: "1:569555436896:web:bd3671f9d3c32daf6e4a05"
};
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize admin auth
        adminAuth.initialize(auth);

        // Make available globally
        window.auth = auth;
        window.db = db;
        window.firebaseApp = app;
    </script>
</head>
<body>
    <script src="admin-auth.js"></script>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-lock"></i>
                <h2>Admin Login</h2>
                <p>examsk24.online Control Panel</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Mobile Header -->
        <header class="admin-header">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="admin-logo">
                <i class="fas fa-cog"></i>
                <span>Admin Panel</span>
            </div>
            <div class="admin-user">
                <span id="userEmail"></span>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Mobile Sidebar -->
        <nav class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Dashboard</h3>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="questions">
                        <i class="fas fa-question-circle"></i>
                        <span>Manage Questions</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="tests">
                        <i class="fas fa-file-alt"></i>
                        <span>Manage Tests</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="categories">
                        <i class="fas fa-list-alt"></i>
                        <span>Categories</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="users">
                        <i class="fas fa-users"></i>
                        <span>Users</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="analytics">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="settings">
                        <i class="fas fa-cogs"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <p>Welcome to examsk24.online Admin Panel</p>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalQuestions">0</h3>
                            <p>Total Questions</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalTests">0</h3>
                            <p>Total Tests</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="todayAttempts">0</h3>
                            <p>Today's Attempts</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="activity-section">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recentActivity">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Manage Questions -->
            <section id="questions" class="content-section">
                <div class="section-header">
                    <h2>Manage Questions</h2>
                    <button class="btn-add" id="addQuestionBtn">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
                
                <div class="questions-list" id="questionsList">
                    <!-- Questions will be loaded here -->
                </div>
            </section>

            <!-- Manage Tests -->
            <section id="tests" class="content-section">
                <div class="section-header">
                    <h2>Manage Tests</h2>
                    <button class="btn-add" id="addTestBtn">
                        <i class="fas fa-plus"></i> Add Test
                    </button>
                </div>
                
                <div class="tests-grid" id="testsGrid">
                    <!-- Tests will be loaded here -->
                </div>
            </section>

            <!-- Other sections will follow similar pattern -->
        </main>
    </div>

    <!-- Modals -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add/Edit Question</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="questionForm" class="modal-form">
                <input type="hidden" id="questionId">
                <div class="form-group">
                    <label>Category</label>
                    <select id="questionCategory" required>
                        <option value="">Select Category</option>
                        <option value="ccc">CCC</option>
                        <option value="banking">Banking</option>
                        <option value="ssc">SSC</option>
                        <option value="gk">GK</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Question</label>
                    <textarea id="questionText" rows="3" required></textarea>
                </div>
                <div class="options-grid">
                    <div class="form-group">
                        <label>Option A</label>
                        <input type="text" id="optionA" required>
                    </div>
                    <div class="form-group">
                        <label>Option B</label>
                        <input type="text" id="optionB" required>
                    </div>
                    <div class="form-group">
                        <label>Option C</label>
                        <input type="text" id="optionC" required>
                    </div>
                    <div class="form-group">
                        <label>Option D</label>
                        <input type="text" id="optionD" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Correct Answer</label>
                    <select id="correctAnswer" required>
                        <option value="">Select Correct Option</option>
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Explanation</label>
                    <textarea id="explanation" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Question</button>
                    <button type="button" class="btn-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>


<script>
const loginScreen = document.getElementById('loginScreen');
const adminPanel = document.getElementById('adminPanel');
const loginForm = document.getElementById('loginForm');
const logoutBtn = document.getElementById('logoutBtn');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const userEmail = document.getElementById('userEmail');
const contentSections = document.querySelectorAll('.content-section');
const sidebarLinks = document.querySelectorAll('.sidebar-menu a');

// Firebase Collections
const questionsRef = db.collection('questions');
const testsRef = db.collection('tests');
const usersRef = db.collection('users');
const attemptsRef = db.collection('attempts');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    checkAdminAuth();
    initEventListeners();
});

function initEventListeners() {
    // Login form
    loginForm.addEventListener('submit', handleLogin);
    
    // Logout
    logoutBtn.addEventListener('click', handleLogout);
    
    // Mobile menu toggle
    menuToggle.addEventListener('click', toggleSidebar);
    
    // Sidebar navigation
    sidebarLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const section = link.getAttribute('data-section');
            showSection(section);
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
            }
        });
    });
    
    // Modal close buttons
    document.querySelectorAll('.modal-close, .btn-cancel').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    });
    
    // Add question button
    document.getElementById('addQuestionBtn').addEventListener('click', () => {
        showQuestionModal();
    });
    
    // Question form
    document.getElementById('questionForm').addEventListener('submit', saveQuestion);
}

// Authentication handlers
function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    adminLogin(email, password)
        .then(user => {
            console.log('Admin logged in:', user.email);
        })
        .catch(error => {
            document.getElementById('loginError').textContent = error.message;
        });
}

function handleLogout() {
    adminLogout()
        .then(() => {
            console.log('Admin logged out');
        })
        .catch(error => {
            console.error('Logout error:', error);
        });
}

// Navigation
function toggleSidebar() {
    sidebar.classList.toggle('active');
}

function showSection(sectionId) {
    // Hide all sections
    contentSections.forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all links
    sidebarLinks.forEach(link => {
        link.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Set active link
    document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
    
    // Load section data
    loadSectionData(sectionId);
}

// Firebase Operations
async function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'dashboard':
            await loadDashboardStats();
            await loadRecentActivity();
            break;
        case 'questions':
            await loadQuestions();
            break;
        case 'tests':
            await loadTests();
            break;
    }
}

async function loadDashboardStats() {
    try {
        // Get total questions
        const questionsSnapshot = await questionsRef.get();
        document.getElementById('totalQuestions').textContent = questionsSnapshot.size;
        
        // Get total tests
        const testsSnapshot = await testsRef.get();
        document.getElementById('totalTests').textContent = testsSnapshot.size;
        
        // Get total users
        const usersSnapshot = await usersRef.get();
        document.getElementById('totalUsers').textContent = usersSnapshot.size;
        
        // Get today's attempts
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayAttempts = await attemptsRef
            .where('timestamp', '>=', today)
            .get();
        document.getElementById('todayAttempts').textContent = todayAttempts.size;
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

async function loadRecentActivity() {
    try {
        const activityList = document.getElementById('recentActivity');
        activityList.innerHTML = '';
        
        // Get recent attempts
        const recentAttempts = await attemptsRef
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get();
        
        recentAttempts.forEach(doc => {
            const attempt = doc.data();
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="activity-content">
                    <h4>Test Attempted</h4>
                    <p>${attempt.userEmail} completed ${attempt.testName}</p>
                    <span class="activity-time">${formatTime(attempt.timestamp)}</span>
                </div>
            `;
            activityList.appendChild(item);
        });
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

async function loadQuestions() {
    try {
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = '<div class="loading">Loading questions...</div>';
        
        const snapshot = await questionsRef.orderBy('createdAt', 'desc').get();
        
        questionsList.innerHTML = '';
        
        snapshot.forEach(doc => {
            const question = doc.data();
            const item = document.createElement('div');
            item.className = 'question-item';
            item.innerHTML = `
                <div class="question-content">
                    <h4>${question.question}</h4>
                    <div class="question-meta">
                        <span>Category: ${question.category}</span>
                        <span>Type: ${question.type || 'MCQ'}</span>
                    </div>
                </div>
                <div class="question-actions">
                    <button class="btn-edit" data-id="${doc.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-delete" data-id="${doc.id}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            questionsList.appendChild(item);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editQuestion(btn.dataset.id));
        });
        
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', () => deleteQuestion(btn.dataset.id));
        });
        
    } catch (error) {
        console.error('Error loading questions:', error);
        questionsList.innerHTML = '<div class="error">Error loading questions</div>';
    }
}

// Question Management
function showQuestionModal(questionId = null) {
    const modal = document.getElementById('questionModal');
    const form = document.getElementById('questionForm');
    
    if (questionId) {
        // Edit mode
        form.querySelector('h3').textContent = 'Edit Question';
        loadQuestionData(questionId);
    } else {
        // Add mode
        form.querySelector('h3').textContent = 'Add Question';
        form.reset();
        document.getElementById('questionId').value = '';
    }
    
    modal.style.display = 'flex';
}

async function loadQuestionData(questionId) {
    try {
        const doc = await questionsRef.doc(questionId).get();
        if (doc.exists) {
            const question = doc.data();
            document.getElementById('questionId').value = questionId;
            document.getElementById('questionCategory').value = question.category;
            document.getElementById('questionText').value = question.question;
            document.getElementById('optionA').value = question.options?.A || '';
            document.getElementById('optionB').value = question.options?.B || '';
            document.getElementById('optionC').value = question.options?.C || '';
            document.getElementById('optionD').value = question.options?.D || '';
            document.getElementById('correctAnswer').value = question.answer;
            document.getElementById('explanation').value = question.explanation || '';
        }
    } catch (error) {
        console.error('Error loading question:', error);
    }
}

async function saveQuestion(e) {
    e.preventDefault();
    
    const questionId = document.getElementById('questionId').value;
    const questionData = {
        category: document.getElementById('questionCategory').value,
        question: document.getElementById('questionText').value,
        options: {
            A: document.getElementById('optionA').value,
            B: document.getElementById('optionB').value,
            C: document.getElementById('optionC').value,
            D: document.getElementById('optionD').value
        },
        answer: document.getElementById('correctAnswer').value,
        explanation: document.getElementById('explanation').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        if (questionId) {
            // Update existing question
            await questionsRef.doc(questionId).update(questionData);
        } else {
            // Add new question
            questionData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await questionsRef.add(questionData);
        }
        
        // Close modal and refresh list
        document.getElementById('questionModal').style.display = 'none';
        loadQuestions();
        
    } catch (error) {
        console.error('Error saving question:', error);
        alert('Error saving question: ' + error.message);
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question?')) return;
    
    try {
        await questionsRef.doc(questionId).delete();
        loadQuestions();
    } catch (error) {
        console.error('Error deleting question:', error);
        alert('Error deleting question: ' + error.message);
    }
}

// Utility Functions
function formatTime(timestamp) {
    if (!timestamp) return '';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
    return `${Math.floor(diff / 86400000)} days ago`;
}

// Admin Panel Show/Hide
function showLoginForm() {
    loginScreen.style.display = 'flex';
    adminPanel.style.display = 'none';
}

function showAdminPanel() {
    loginScreen.style.display = 'none';
    adminPanel.style.display = 'block';
    userEmail.textContent = auth.currentUser?.email;
    showSection('dashboard');
}
    </script>
</body>
</html>